const express = require("express");
const TelegramBot = require("node-telegram-bot-api");

/* ================== –ù–ê–õ–ê–®–¢–£–í–ê–ù–ù–Ø ================== */

const BOT_TOKEN = "PASTE_BOT_TOKEN";
const PROVIDER_TOKEN = "PASTE_PROVIDER_TOKEN"; // –∑ BotFather
const BOT_USERNAME = "PASTE_BOT_USERNAME";     // –±–µ–∑ @

/* ================================================= */

const app = express();
const bot = new TelegramBot(BOT_TOKEN, { polling: true });

/* ================== HTML –ì–†–ò ================== */

const GAME_HTML = `
<!DOCTYPE html>
<html lang="uk">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>TapDay</title>

<style>
body {
  margin:0;
  background:#0f1220;
  color:white;
  font-family:Arial, sans-serif;
  display:flex;
  flex-direction:column;
  align-items:center;
  justify-content:center;
  height:100vh;
}
#tap {
  width:220px;
  height:220px;
  border-radius:50%;
  background:linear-gradient(135deg,#ff9800,#ff5722);
  display:flex;
  align-items:center;
  justify-content:center;
  font-size:36px;
  user-select:none;
}
.btn {
  margin-top:15px;
  padding:14px 22px;
  border-radius:14px;
  font-size:18px;
  border:none;
  color:white;
}
.green { background:#4caf50; }
.blue { background:#2196f3; }
</style>
</head>

<body>

<h1>TapDay</h1>

<div id="tap">TAP</div>
<div id="score">0 üí∞</div>

<button class="btn green" onclick="donate()">üíé –ü—ñ–¥—Ç—Ä–∏–º–∞—Ç–∏ –≥—Ä—É</button>

<script>
let score = 0;
const tap = document.getElementById("tap");
const scoreEl = document.getElementById("score");

tap.addEventListener("click", () => {
  score++;
  scoreEl.textContent = score + " üí∞";

  if (window.Telegram?.WebApp?.HapticFeedback) {
    Telegram.WebApp.HapticFeedback.impactOccurred("light");
  }
});

function donate() {
  Telegram.WebApp.openTelegramLink(
    "https://t.me/${BOT_USERNAME}?start=donate"
  );
}
</script>

</body>
</html>
`;

/* ================== WEBAPP ================== */

app.get("/", (req, res) => {
  res.send(GAME_HTML);
});

/* ================== TELEGRAM BOT ================== */

bot.onText(/\/start/, (msg) => {
  bot.sendMessage(
    msg.chat.id,
    "üéÆ TapDay –∑–∞–ø—É—â–µ–Ω–æ!",
    {
      reply_markup: {
        inline_keyboard: [[
          { text: "üíé –ü—ñ–¥—Ç—Ä–∏–º–∞—Ç–∏ –≥—Ä—É", callback_data: "donate" }
        ]]
      }
    }
  );
});

bot.on("callback_query", (q) => {
  if (q.data === "donate") {
    bot.sendInvoice(
      q.message.chat.id,
      "TapDay üíé",
      "100 –º–æ–Ω–µ—Ç —É –≥—Ä—ñ",
      "tapday_payload",
      PROVIDER_TOKEN,
      "UAH",
      [
        { label: "100 –º–æ–Ω–µ—Ç", amount: 5000 } // 50 –≥—Ä–Ω
      ]
    );
  }
});

bot.on("pre_checkout_query", (q) => {
  bot.answerPreCheckoutQuery(q.id, true);
});

bot.on("successful_payment", (msg) => {
  console.log("üí∞ –û–ü–õ–ê–¢–ê –£–°–ü–Ü–®–ù–ê:", msg.successful_payment);
});

/* ================== START SERVER ================== */

app.listen(3000, () => {
  console.log("üöÄ TapDay –ø—Ä–∞—Ü—é—î: http://localhost:3000");
});
