const express = require("express");
const TelegramBot = require("node-telegram-bot-api");

const BOT_TOKEN = "–¢–£–¢_–¢–û–ö–ï–ù_–ë–û–¢–ê";
const PROVIDER_TOKEN = "–¢–£–¢_PROVIDER_TOKEN_STRIPE";

const app = express();
const bot = new TelegramBot(BOT_TOKEN, { polling: true });

/* ---------- HTML –ì–†–ò ---------- */
const GAME_HTML = `
<!DOCTYPE html>
<html lang="uk">
<head>
<meta charset="UTF-8">
<title>TapDay</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
body{
  margin:0;
  background:#0f1220;
  color:white;
  font-family:Arial;
  display:flex;
  flex-direction:column;
  align-items:center;
  justify-content:center;
  height:100vh;
}
#tap{
  width:200px;
  height:200px;
  border-radius:50%;
  background:linear-gradient(135deg,#ff9800,#ff5722);
  display:flex;
  align-items:center;
  justify-content:center;
  font-size:32px;
}
.btn{
  margin-top:15px;
  padding:14px 22px;
  border-radius:12px;
  cursor:pointer;
}
#donate{background:#00c853;}
</style>
</head>
<body>

<h2>TapDay üí∞</h2>
<div id="tap">TAP</div>
<div id="score">0</div>
<div id="donate" class="btn">üíé –ü—ñ–¥—Ç—Ä–∏–º–∞—Ç–∏ –≥—Ä—É</div>

<script>
let score = Number(localStorage.getItem("score")) || 0;
const scoreEl = document.getElementById("score");
scoreEl.textContent = score;

tap.onclick = () => {
  score++;
  localStorage.setItem("score", score);
  scoreEl.textContent = score;

  if (window.Telegram?.WebApp) {
    Telegram.WebApp.HapticFeedback.impactOccurred("light");
  }
};

donate.onclick = () => {
  Telegram.WebApp.openTelegramLink(
    "https://t.me/–¢–í–Ü–ô_–ë–û–¢?start=donate"
  );
};
</script>

</body>
</html>
`;

/* ---------- WEBAPP ---------- */
app.get("/", (req, res) => {
  res.send(GAME_HTML);
});

/* ---------- TELEGRAM PAYMENTS ---------- */
bot.onText(/\/start donate/, (msg) => {
  bot.sendInvoice(
    msg.chat.id,
    "TapDay üíé",
    "100 –º–æ–Ω–µ—Ç —É –≥—Ä—ñ",
    "tapday_payload",
    PROVIDER_TOKEN,
    "UAH",
    [{ label: "100 –º–æ–Ω–µ—Ç", amount: 5000 }]
  );
});

bot.on("pre_checkout_query", q => {
  bot.answerPreCheckoutQuery(q.id, true);
});

bot.on("successful_payment", msg => {
  console.log("üí∞ –û–ü–õ–ê–¢–ê –£–°–ü–Ü–®–ù–ê:", msg.successful_payment);
});

/* ---------- START ---------- */
app.listen(3000, () => {
  console.log("üöÄ TapDay –∑–∞–ø—É—â–µ–Ω–æ –Ω–∞ http://localhost:3000");
});
